name: Lint, Test, Build and Deploy SST

on:
  push:
    branches: [main]
    paths-ignore:
      - pyproject.toml
      - uv.lock
  workflow_dispatch:    # Allow manual triggering of the workflow

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  RESOURCE_NAME_DOCKER: ${{ github.repository }}

jobs:
  lint-and-format:
    name: Lint and format
    uses: ./.github/workflows/reusable/lint-and-format.yml

  scan:
    name: Scan
    uses: ./.github/workflows/reusable/scan.yml

  test:
    name: Tests
    uses: ./.github/workflows/reusable/test.yml

  version:
    name: Compute version
    uses: ./.github/workflows/reusable/version.yml

  build-deploy:
    name: Build + deploy container image
    needs: [lint-and-format, scan, test, version]
    if: needs.version.result == 'success'
    uses: ./.github/workflows/reusable/build-deploy.yml
    with:
      app_version: ${{ needs.version.outputs.app_version }}
    secrets: inherit

  release:
    name: Tag + GitHub release
    needs: [version, build-deploy]
    if: needs.version.result == 'success'
    uses: ./.github/workflows/reusable/release.yml
    with:
      app_version: ${{ needs.version.outputs.app_version }}
    secrets: inherit
